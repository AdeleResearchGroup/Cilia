
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at Dec 24, 2013
 Rendered using Reflow Maven Skin 1.0.1-SNAPSHOT (http://andriusvelykis.github.com/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>Linker Creation | iCasa</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />

		<link href="http://netdna.bootstrapcdn.com/bootswatch/2.2.2/spacelab/bootstrap.min.css" rel="stylesheet" />
		<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.min.css" rel="stylesheet" />
		<link href="./css/bootswatch.css" rel="stylesheet" />
		<link href="./css/reflow-skin.css" rel="stylesheet" />
		
		<link href="http://yandex.st/highlightjs/7.3/styles/default.min.css" rel="stylesheet" />
		
		<link href="./css/lightbox.css" rel="stylesheet" />
		
		<link href="./css/site.css" rel="stylesheet" />
		<link href="./css/print.css" rel="stylesheet" media="print" />
		
		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		
<link rel="stylesheet" type="text/css" href="./css/site.css"/>
<link rel="stylesheet" type="text/css" href="./css/font-awesome.css"/>
<script type="text/javascript">var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-35847694-2']);
                _gaq.push(['_trackPageview']);

                (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();</script>
<script type="text/javascript">$(document).ready(function () {
                $("pre code").parent().addClass("prettyprint");
                prettyPrint();
                });</script>
<link rel="shortcut icon" href="favicon.png"/>
	</head>

	<body class="page-linker project-cilia-parent-reactor" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="http://github.com/AdeleResearchGroup/Cilia">Cilia on github</a>
					<div class="nav-collapse">
						<ul class="nav pull-right">
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Cilia <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="index.html" title="Home">Home </a></li>
									<li><a href="overview.html" title="Overview">Overview </a></li>
									<li><a href="download.html" title="Download">Download </a></li>
									<li><a href="components.html" title="Available components">Available components </a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="quickstart.html" title="Quick start">Quick start </a></li>
									<li><a href="dsl.html" title="DSL Reference">DSL Reference </a></li>
									<li><a href="rest-api.html" title="REST API">REST API </a></li>
									<li><a href="gogo-commands.html" title="Gogo commands">Gogo commands </a></li>
									<li><a href="apidocs/index.html" title="Javadoc">Javadoc </a></li>
								</ul>
							</li>
							<li class="dropdown active">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Advanced tutorials <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li class="active"><a href="" title="Creating a new Linker">Creating a new Linker </a></li>
									<li><a href="adapter.html" title="Creating new adapter">Creating new adapter </a></li>
									<li><a href="monitor.html" title="Using monitoring capabilities">Using monitoring capabilities </a></li>
									<li><a href="extendDSL.html" title="Extending the DSL Language">Extending the DSL Language </a></li>
									<li class="dropdown-submenu">
										<a href="linker.html#" title="Runtime Manipulation">Runtime Manipulation </a>
										<ul class="dropdown-menu">
											<li><a href="builder.html" title="Cilia Admin Builder Pattern">Cilia Admin Builder Pattern </a></li>
											<li><a href="ciliaAdmin.html" title="Cilia Admin Service">Cilia Admin Service </a></li>
										</ul>
									</li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>
		
	<div class="container">
	
	<!-- Masthead
	================================================== -->
	<header class="jumbotron subhead">
		<div class="row" id="banner">
			<div class="span12">
				<div class="pull-left">
					<a href="linker.html#" id="bannerLeft"><img src="cilia-small.png" alt='"'Cilia - A service mediation framework for dynamic applications'"' /></a>
					<p class="lead">A service mediation framework for dynamic applications</p>
				</div>
				<div class="pull-right">
				</div>
			</div>
		</div>
		<hr class="toc-separator" />
		<div id="toc-bar" class="navbar">
			<div class="navbar-inner">
				<div id="toc-scroll-target" class="container">
					<ul id="toc" class="nav">
						<li class="toplevel"><a href="#linker_creation" title="Linker Creation">Linker Creation</a></li>
						<li class="toplevel"><a href="#Create_the_project" title="Create the project">Create the project</a></li>
						<li class="toplevel"><a href="#Creating_the_Event_Admin_Sender" title="Creating the Event Admin Sender">Creating the Event Admin Sender</a></li>
						<li class="toplevel"><a href="#Creating_the_Event_Admin_Collector" title="Creating the Event Admin Collector">Creating the Event Admin Collector</a></li>
						<li class="toplevel"><a href="#Create_the_Event_Admin_Linker_Service" title="Create the Event Admin Linker Service">Create the Event Admin Linker Service</a></li>
						<li class="toplevel"><a href="#Sample_Application" title="Sample Application">Sample Application</a></li>
					</ul>
				</div>
			</div>
		</div>
	</header>

	<div class="main-body">
	<div class="row">
		<div class="span12">
			<div class="body-content">
<div class="page-header">
 <h1 id="linker_creation">Linker Creation</h1>
</div> 
<p>Linkers are components (and OSGi srvices) in charge of performing the binding operation between two mediators using a defined protocol.</p> 
<p>In that sense, bindings are a logical relation between a source mediator and a target mediator. And the protocol is the way mediators communicate in order to share or send information while running.</p> 
<p>So, the linker service is the one who configure and add <i>sender</i> and <i>collector</i> elements to both source and target mediators.</p> 
<p>In this section we will learn how to, first create the collector and sender in charge of communication between components, then how to create a linker component which will plug those elements to the desired mediator components.</p> 
<p>This tutorial is based on the <i>Event Admin</i> service provided by the Apache Felix project. <a class="externalLink" href="http://felix.apache.org/site/apache-felix-event-admin.html">EA</a> is a publish/subscriber service based on topics.</p> 
<div class="section"> 
 <h2 id="Create_the_project">Create the project</h2> 
 <p>The project is created using Maven, and in order to create an OSGi bundle using iPOJO it is needed to use Maven Bundle Plugin and Maven iPOJO plugin as follows:</p> 
 <div class="source"> 
  <pre>&lt;plugin&gt;
   &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
   &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
   &lt;extensions&gt;true&lt;/extensions&gt;
   &lt;configuration&gt;
      &lt;instructions&gt;
         &lt;Bundle-SymbolicName&gt;${pom.artifactId}&lt;/Bundle-SymbolicName&gt;
         &lt;Private-Package&gt;&lt;/Private-Package&gt;
      &lt;/instructions&gt;
   &lt;/configuration&gt;
&lt;/plugin&gt;
&lt;plugin&gt;
   &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
   &lt;artifactId&gt;maven-ipojo-plugin&lt;/artifactId&gt;
   &lt;executions&gt;
      &lt;execution&gt;
         &lt;goals&gt;
            &lt;goal&gt;ipojo-bundle&lt;/goal&gt;
         &lt;/goals&gt;
      &lt;/execution&gt;
   &lt;/executions&gt;
&lt;/plugin&gt;
</pre> 
 </div> 
 <p>The needed dependencies for this project are two: The cilia run-time and the event admin implementation provided by Apache Felix.</p> 
 <div class="source"> 
  <pre>&lt;dependencies&gt;
   &lt;dependency&gt;
      &lt;groupId&gt;fr.liglab.adele.cilia&lt;/groupId&gt;
      &lt;artifactId&gt;cilia-core&lt;/artifactId&gt;
   &lt;/dependency&gt;
   &lt;dependency&gt;
      &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
      &lt;artifactId&gt;org.apache.felix.eventadmin&lt;/artifactId&gt;
   &lt;/dependency&gt;
&lt;/dependencies&gt;
</pre> 
 </div> 
 <p>On the root of the project, create a file named <i>metadata.xml</i>. This file will contain the specifications of the linker and the constituents created for this project. At this moment, we leave this file empty.</p> 
 <p>In order to create the linker service, first it is needed to create the elements in charge of performing the communication operation for the given protocol as presented on the following section.</p> 
</div> 
<div class="section"> 
 <h2 id="Creating_the_Event_Admin_Sender">Creating the Event Admin Sender</h2> 
 <p>First we need to create a class called EventAdminSender. We place this class on the package <i>fr.liglab.adele.cilia.components.sender.ea</i>. This class must implement the <i>fr.liglab.adele.cilia.framework.ISender</i> interface and implement the <i>send</i> method.</p> 
 <div class="source"> 
  <pre>package fr.liglab.adele.cilia.components.sender.ea;
/* Packages for Cilia*/
import fr.liglab.adele.cilia.framework.ISender;
import fr.liglab.adele.cilia.Data;

public class EventAdminSender implements ISender {

  public boolean send(Data data) {
      /*Here the sending code*/
  }
}
</pre> 
 </div> 
 <p>In order to use Event Admin to publish events, we need to use the Event Admin Service. We complete the code using Event Admin.</p> 
 <div class="source"> 
  <pre>package fr.liglab.adele.cilia.components.sender.ea;
/*Imported classes to use Event Admin*/
import org.osgi.service.event.Event;
import org.osgi.service.event.EventAdmin;
/* Imported classes to implement the Sender Cilia*/
import fr.liglab.adele.cilia.framework.ISender;
import fr.liglab.adele.cilia.Data;

public class EventAdminSender implements ISender {
/**
* Event Admin. Will be injected by iPOJO.
*/
  private EventAdmin eventAdmin;
/**
* Topic to use when sending each data. Also injected by the framework.
*/
  private String topic;
  public boolean send(Data data) {
     /*It will post the contained data on the given topic */
     eventAdmin.postEvent(new Event(topic, data.getAllData()));
     return true;  
  }
}
</pre> 
 </div> 
 <p>In the <i>metadata.xml</i> file we need to add the description of this sender.</p> 
 <div class="source"> 
  <pre>&lt;cilia&gt;
  &lt;sender classname=&quot;fr.liglab.adele.cilia.components.sender.ea.EventAdminSender&quot;  name=&quot;ea-sender&quot; &gt;
      &lt;requires field=&quot;eventAdmin&quot; /&gt; &lt;!--The required Event Admin Service--&gt;
      &lt;properties&gt;
         &lt;property name=&quot;topic&quot; field=&quot;topic&quot; /&gt; &lt;!--The injected topic--&gt;
      &lt;/properties&gt;
   &lt;/sender&gt;
&lt;/cilia&gt;
</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Creating_the_Event_Admin_Collector">Creating the Event Admin Collector</h2> 
 <p>Now, we need to create a collector which will complete the new protocol communication using Event Admin between two mediator components. So create a class named EventAdminCollector. Using eclipse or netbeans we create the new class on the package <i>fr.liglab.adele.cilia.components.collector.ea</i>. To create a collector we need to extend the abstract class <b>fr.liglab.adele.cilia.framework.AbstractCollector</b>. And, to create this specific EventAdmin collector we also implement the <b>org.osgi.service.event.EventHandler</b> interface.</p> 
 <div class="source"> 
  <pre>package fr.liglab.adele.cilia.components.collector.ea;
/* Packages for Cilia*/
import fr.liglab.adele.cilia.framework.AbstractCollector;
import fr.liglab.adele.cilia.Data;
/*Empty collector*/
public class EventAdminCollector extends AbstractCollector {


}
</pre> 
 </div> 
 <p>In order to use Event Admin to publish events, we need to use the Event Admin Service. We complete the code using Event Admin.</p> 
 <div class="source"> 
  <pre>package fr.liglab.adele.cilia.components.collector.ea;
/*Imported classes to use Event Admin*/
import org.osgi.service.event.Event;
import org.osgi.service.event.EventHandler;
/* Imported classes to implement the Sender Cilia*/
import fr.liglab.adele.cilia.Data;
import fr.liglab.adele.cilia.framework.AbstractCollector;

public class EventAdminCollector extends AbstractCollector implements EventHandler {
  /*Method called when receiving an event*/  
  public void handleEvent(Event event) {
    Dictionary dico = new Hashtable(); //to store the incoming data.
    String[] keys = event.getPropertyNames();
    if (keys != null) {
      for (int i = 0; i &lt; keys.length; i++) {
        dico.put(keys[i], event.getProperty(keys[i]));//add the incoming data.
      }
    }
    /*
    * Create new Data object from the received event.
    */
    Data data = new Data(dico.get(Data.DATA_CONTENT),
                          String.valueOf(dico.get(Data.DATA_NAME)), 
                          dico);
    notifyDataArrival(data); //Notify to scheduler that a new Data has arrived.
  }
}
</pre> 
 </div> 
 <p>Now, we need to register the Event Handler in order to be notified when someone wants to send data. We create a register and unregister methods.</p> 
 <div class="source"> 
  <pre>/*Topic to listen events, this field is injected by iPOJO*/
private String topic;
private BundleContext context;
private ServiceRegistration serviceRegistration; //to register the event handler.
private void register() {
  Dictionary dico = new Hashtable();
  String[] topics = {topic}; //We'll listen only one topic.
  dico.put(EventConstants.EVENT_TOPIC, topics);
  if (serviceRegistration != null) {
    serviceRegistration.unregister();
  }
  serviceRegistration = context.registerService(
  EventHandler.class.getName(), this, dico); //register the event listener
}

/**
 * Called when the component stops
 */
public void unregister() {
    if (serviceRegistration != null) {
        serviceRegistration.unregister(); //unregister the event listener.
    }
}
</pre> 
 </div> 
 <p>In the <i>metadata.xml</i> file we need to add the description of this collector.</p> 
 <div class="source"> 
  <pre>&lt;cilia&gt;
 &lt;collector classname=&quot;fr.liglab.adele.cilia.components.collector.ea.EventAdminCollector&quot;   name=&quot;ea-collector&quot; &gt;
   &lt;properties&gt;
      &lt;property name=&quot;topic&quot; field=&quot;topic&quot; /&gt;
   &lt;/properties&gt;
   &lt;callback transition=&quot;validate&quot; method=&quot;register&quot; /&gt;
   &lt;callback transition=&quot;invalidate&quot; method=&quot;unregister&quot; /&gt;
 &lt;/collector&gt;
&lt;/cilia&gt;
</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Create_the_Event_Admin_Linker_Service">Create the Event Admin Linker Service</h2> 
 <p>Now we have created the elements that allow to communicate mediator instances in a given protocol. In this example we use Event Admin as a communication protocol. Now we need to create a linker service which is in charge to connect two mediator components at run-time. This linker service will interact at a model level at run-time, so it will not interact with the executing instances. Instead it will add the correct information to connect them. We need to create another class, in this case it is called EALinkerService. It extends <i>fr.liglab.adele.cilia.runtime.CiliaBindingServiceImpl</i> and implements <i>fr.liglab.adele.cilia.runtime.CiliaBindingService</i>. We place this class on the package <i>fr.liglab.adele.cilia.components.binding.ea</i>. And the only method we need to implement is called <i>getProperties</i></p> 
 <div class="source"> 
  <pre>package fr.liglab.adele.cilia.components.binding.ea;

import java.util.Dictionary;
import java.util.Hashtable;

import fr.liglab.adele.cilia.model.Binding;
import fr.liglab.adele.cilia.runtime.CiliaBindingService;
import fr.liglab.adele.cilia.runtime.CiliaBindingServiceImpl;

public class EALinkerService extends CiliaBindingServiceImpl implements
CiliaBindingService {
  public Dictionary getProperties(Dictionary collectorProperties,
    Dictionary senderProperties, Binding bindingInfo) {
    Dictionary properties = new Hashtable();

    //with the information on bindingInfo we generate a topic property.
    String topic = generateTopic(bindingInfo); 

    /*Set the properties that will be injected on the sender/collector respectively*/
    collectorProperties.put(&quot;topic&quot;, topic);
    senderProperties.put(&quot;topic&quot;, topic);

    /*We add the corresponding properties to a global properties container*/
    properties.put(CILIA_COLLECTOR_PROPERTIES, collectorProperties);
    properties.put(CILIA_SENDER_PROPERTIES, senderProperties);
    return properties;
  }
}
</pre> 
 </div> 
 <p>The topic generation could be as follows:</p> 
 <div class="source"> 
  <pre>  private String generateTopic(Binding b) {
    StringBuffer topic = new StringBuffer();
    /**
    *The topic is as follows chainId/mediatorSourceId/mediatorTargetId
    */
    topic.append(b.getChain().getId());
    topic.append(&quot;/&quot;);
    topic.append(b.getSourceMediator().getId());
    topic.append(&quot;/&quot;);
    topic.append(b.getTargetMediator().getId());
    return topic.toString();
  }
</pre> 
 </div> 
 <p>The framework will create the sender and collector instance with the given information.</p> 
 <p>Now, we need to specify the new linker on the <i>metadata.xml</i></p> 
 <div class="source"> 
  <pre>&lt;linker classname=&quot;fr.liglab.adele.cilia.components.binding.ea.EALinkerService&quot; name=&quot;event-admin&quot;&gt;
  &lt;collector name=&quot;ea-collector&quot; /&gt;
  &lt;sender name=&quot;ea-sender&quot;  /&gt;
&lt;/linker&gt;
</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Sample_Application">Sample Application</h2> 
 <p>And thats all. Now we can use the new linker on any mediation chain. For example, to use this linker on the Hello World, we modify the DSCilia file as follows:</p> 
 <div class="source"> 
  <pre>&lt;cilia&gt;
  &lt;chain id=&quot;HelloWorldChain&quot;&gt;

    &lt;!-- Adapters instances definition --&gt;
    &lt;adapters&gt;
      &lt;adapter-instance type=&quot;gui-adapter&quot; id=&quot;entryAdapter&quot; /&gt;
      &lt;adapter-instance type=&quot;console-adapter&quot; id=&quot;exitAdapter&quot; /&gt;
    &lt;/adapters&gt;

    &lt;!-- Mediators instances definition --&gt;
    &lt;mediators&gt;
      &lt;mediator-instance type=&quot;HelloMediator&quot; id=&quot;hello&quot;&gt;
        &lt;ports&gt;
          &lt;in-port name=&quot;in&quot; /&gt;
          &lt;out-port name=&quot;out&quot; /&gt;
        &lt;/ports&gt;
      &lt;/mediator-instance&gt;
    &lt;/mediators&gt;

    &lt;!-- Bindings definition With Event Admin --&gt;
    &lt;bindings&gt;
      &lt;binding from=&quot;entryAdapter&quot; to=&quot;hello:in&quot; linker=&quot;event-admin&quot; /&gt;
      &lt;binding from=&quot;hello:out&quot; to=&quot;exitAdapter&quot; linker=&quot;event-admin&quot; /&gt;
    &lt;/bindings&gt;

  &lt;/chain&gt;
&lt;/cilia&gt;
</pre> 
 </div> 
</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->
	
	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="span9 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Cilia</li>
						<li>
							<a href="index.html" title="Home">Home </a>
						</li>
						<li>
							<a href="overview.html" title="Overview">Overview </a>
						</li>
						<li>
							<a href="download.html" title="Download">Download </a>
						</li>
						<li>
							<a href="components.html" title="Available components">Available components </a>
						</li>
						<li class="nav-header">Documentation</li>
						<li>
							<a href="quickstart.html" title="Quick start">Quick start </a>
						</li>
						<li>
							<a href="dsl.html" title="DSL Reference">DSL Reference </a>
						</li>
						<li>
							<a href="rest-api.html" title="REST API">REST API </a>
						</li>
						<li>
							<a href="gogo-commands.html" title="Gogo commands">Gogo commands </a>
						</li>
						<li>
							<a href="apidocs/index.html" title="Javadoc">Javadoc </a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-description">
					<blockquote>A service mediation framework for dynamic applications.</blockquote>
				</div>
			</div>
		</div>
	</footer>
		
	<div class="container subfooter">
		<div class="row">
			<div class="span12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2012-2013 <a href="http://adele.imag.fr">Adele Team | LIG</a>. All Rights Reserved.</p>
				<p class="version-date"><span class="projectVersion">Version: 1.7.4-SNAPSHOT. </span><span class="publishDate">Last Published: 2013-12-24. </span></p>
				<p><a href="http://github.com/andriusvelykis/reflow-maven-skin" title="Reflow Maven skin">Reflow Maven skin</a> by <a href="http://andrius.velykis.lt" target="_blank" title="Andrius Velykis">Andrius Velykis</a>.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->

	<!-- Fallback jQuery loading from Google CDN:
	     http://stackoverflow.com/questions/1014203/best-way-to-use-googles-hosted-jquery-but-fall-back-to-my-hosted-library-on-go -->
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script type="text/javascript">
		if (typeof jQuery == 'undefined')
		{
			document.write(unescape("%3Cscript src='./js/jquery-1.8.3.min.js' type='text/javascript'%3E%3C/script%3E"));
		}
	</script>
	
	<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
	<script src="./js/lightbox.js"></script>
	<script src="./js/jquery.smooth-scroll.min.js"></script>
	<!-- back button support for smooth scroll -->
	<script src="./js/jquery.ba-bbq.min.js"></script>
	<script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>

	<script src="./js/reflow-skin.js"></script>
	
	</body>
</html>
